<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CaptureHistory - Gallery</title>
    <style>
        /* --- CSS TETAP SAMA (STYLE LAMA) --- */
        :root { --bg: #000000; --card: #111111; --accent: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { background-color: var(--bg); color: #fff; font-family: -apple-system, sans-serif; overflow-x: hidden; }

        header { padding: 20px; text-align: center; background: rgba(0,0,0,0.8); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 50; border-bottom: 1px solid #222; }
        header h1 { font-size: 0.9rem; letter-spacing: 4px; font-weight: 300; opacity: 0.9; }

        .section { margin-top: 30px; opacity: 0; animation: fadeUp 0.6s forwards; }
        .sec-title { padding: 0 20px 15px; font-size: 0.7rem; text-transform: uppercase; color: #666; letter-spacing: 2px; }
        
        .slider { display: flex; gap: 12px; padding: 0 20px 30px; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
        .slider::-webkit-scrollbar { display: none; }

        .card {
            flex: 0 0 80%; aspect-ratio: 3/4; scroll-snap-align: center;
            background: var(--card); border-radius: 14px; overflow: hidden;
            position: relative; border: 1px solid #222;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        }

        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.2); display: flex; justify-content: center; align-items: center;
        }
        .play-icon {
            width: 45px; height: 45px; background: rgba(255,255,255,0.2); backdrop-filter: blur(4px);
            border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid rgba(255,255,255,0.4);
        }
        .play-icon::after { content:''; margin-left:4px; border-left:14px solid #fff; border-top:9px solid transparent; border-bottom:9px solid transparent; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 100; flex-direction: column; }
        .modal-body { flex: 1; display: flex; justify-content: center; align-items: center; width: 100%; position: relative; }
        
        /* FIX GAMBAR MODAL AGAR TIDAK HILANG */
        .modal-body img, .modal-body video { 
            max-width: 100%; max-height: 80vh; 
            object-fit: contain; 
            display: block; /* Pastikan display block */
        }
        
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 2.5rem; color: #fff; z-index: 102; cursor: pointer; }
        
        .modal-footer { padding: 30px; text-align: center; background: #000; z-index: 101; }
        .btn-dl {
            background: #fff; color: #000; text-decoration: none; padding: 15px 40px; 
            border-radius: 30px; font-weight: bold; font-size: 0.9rem; display: inline-block;
            box-shadow: 0 5px 20px rgba(255,255,255,0.2);
        }
        .loading { text-align: center; padding: 100px 0; color: #444; font-size: 0.8rem; letter-spacing: 1px; }

        @keyframes fadeUp { to { opacity: 1; } }
    </style>
</head>
<body>

<header><h1>CAPTURE HISTORY</h1></header>

<div id="app">
    <div class="loading">MEMUAT DATABASE...</div>
</div>

<div id="modal" class="modal">
    <div class="modal-close" onclick="closeModal()">Ã—</div>
    <div class="modal-body" id="modalView"></div>
    <div class="modal-footer">
        <a id="dlBtn" href="#" class="btn-dl">SIMPAN KE GALERI</a>
    </div>
</div>

<script>
    // MASUKKAN URL APPS SCRIPT ANDA DI SINI
    const API_URL = "https://script.google.com/macros/s/AKfycbzkSaiupIzehCI_w2a3UAP252GNqvAELpkpxeyOw_H3vECEXpExetL2r8XeMTbdznhO4Q/exec";

    async function init() {
        try {
            const req = await fetch(API_URL);
            const data = await req.json();
            const app = document.getElementById('app');
            app.innerHTML = '';

            // URUTAN SESUAI REQUEST: Prints -> Originals -> Animated
            const categories = ["Prints", "Originals", "Animated"];

            categories.forEach(cat => {
                if(data[cat] && data[cat].length > 0) {
                    const isVideo = (cat === "Animated");
                    const section = document.createElement('div');
                    section.className = 'section';
                    
                    let itemsHtml = '';
                    
                    // HAPUS .reverse() AGAR TIDAK RUSAK/URUTAN NORMAL
                    data[cat].forEach(item => {
                        const fileId = item.id;
                        
                        // 1. Link Kartu Depan (Thumbnail Kecil)
                        const thumbUrl = `https://drive.google.com/thumbnail?sz=w600&id=${fileId}`;
                        
                        // 2. Link Download Asli (Untuk Tombol Simpan)
                        const rawDlUrl = `https://drive.google.com/uc?export=download&id=${fileId}`;
                        
                        // 3. Link View Modal (FIX GAMBAR HILANG)
                        // Jika Video -> Pakai link download/stream
                        // Jika Foto -> Pakai link Thumbnail High Res (w1200) agar pasti muncul
                        const viewUrl = isVideo ? rawDlUrl : `https://drive.google.com/thumbnail?sz=w1200&id=${fileId}`;

                        if(isVideo) {
                            itemsHtml += `
                                <div class="card" onclick="openModal('${viewUrl}', '${rawDlUrl}', true)">
                                    <img src="${thumbUrl}" loading="lazy" alt="Video Thumb">
                                    <div class="play-overlay"><div class="play-icon"></div></div>
                                </div>`;
                        } else {
                            itemsHtml += `
                                <div class="card" onclick="openModal('${viewUrl}', '${rawDlUrl}', false)">
                                    <img src="${thumbUrl}" loading="lazy" alt="Foto">
                                </div>`;
                        }
                    });

                    section.innerHTML = `
                        <div class="sec-title">${cat}</div>
                        <div class="slider">${itemsHtml}</div>
                    `;
                    app.appendChild(section);
                }
            });
            
            initObserver();

        } catch (e) {
            console.error(e);
            document.querySelector('.loading').innerText = "GAGAL MEMUAT. CEK KONEKSI.";
        }
    }

    // FUNGSI MODAL DIPERBAIKI
    function openModal(viewUrl, dlUrl, isVideo) {
        const modal = document.getElementById('modal');
        const view = document.getElementById('modalView');
        const btn = document.getElementById('dlBtn');

        view.innerHTML = ''; // Reset

        if(isVideo) {
            // Video Player
            view.innerHTML = `<video src="${viewUrl}" controls autoplay loop playsinline style="width:100%"></video>`;
        } else {
            // Image Viewer
            view.innerHTML = `<img src="${viewUrl}" alt="Preview Full">`;
        }

        // Setup Tombol Download (Mengarah ke Link Download Asli)
        btn.href = dlUrl;
        btn.onclick = (e) => {
            // Native Browser Download
            btn.innerText = "MEMPROSES...";
            setTimeout(() => btn.innerText = "SIMPAN KE GALERI", 3000);
        };

        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeModal() {
        document.getElementById('modal').style.display = 'none';
        document.getElementById('modalView').innerHTML = ''; // Stop video/clear img
        document.body.style.overflow = 'auto';
    }

    function initObserver() {
        const obs = new IntersectionObserver(entries => {
            entries.forEach(e => {
                e.target.style.transform = e.isIntersecting ? "scale(1)" : "scale(0.95)";
            });
        }, { threshold: 0.6 });
        document.querySelectorAll('.card').forEach(c => obs.observe(c));
    }

    init();
</script>
</body>
</html>
